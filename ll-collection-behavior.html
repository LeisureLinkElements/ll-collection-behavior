<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../ll-firelog-behavior/ll-firelog-behavior.html">

<script type="application/javascript" src="../lodash/lodash.js"></script>

<script>

  var LeisureLinkBehaviors = LeisureLinkBehaviors || {};

  /**
   * ### Summary
   *
   * Adds collection-management functionality to an element with a repeating template.
   *
   * ### Usage
   *
   * 1. Add this behavior to an element with a dom-repeat template.
   * 1. Add a 'lcb-items-name' property to the element.
   * 1. Set the value to the name of the property to which the dom-repeat items are bound.
   * 1. Optionally add a delete button to each item by adding it within the dom-repeat template. Example:
   *        <button on-click="_lcbDeleteMe">DELETE THIS ITEM</button>
   * 1. Optionally add trash/un-trash button. (The _lcbTrashMe method toggles trashing.) Example:
   *        <button on-click="_lcbTrashMe">TRASH / UNTRASH THIS ITEM</button>
   * 1. Empty the trash by calling lcbEmptyTrash().
   *
   *
   * @demo
   * @polymerBehavior
   */
  LeisureLinkBehaviors.CollectionBehaviorImpl = {

    properties: {

      /**
       * Name of the property containing the items for this collection; eg: 'employees'
       */
      lcbItemsName: String

    },

    listeners: {
      'lcb-trash-me': '_lcbTrashMe',
      'lcb-delete-me': '_lcbDeleteMe'
    },

    /**
     * Get an item by index.
     *
     * @param idx {number}
     */
    lcbGetItemByIndex: function (idx) {
      if (this._isValidIndex(idx)) {
        return this[this.lcbItemsName][idx];
      }
    },

    /**
     * Add item to collection.
     *
     * @param data {object} Optional data for new item.
     */
    lcbAdd: function (data) {
      this.push(this.lcbItemsName, data || {});
    },

    /**
     * Delete an item by index.
     *
     * @param idx {number}
     */
    lcbDelete: function (idx) {
      if (this._isValidIndex(idx)) {
        var deletedItem = _.cloneDeep(this.lcbGetItemByIndex(idx));
        this.splice(this.lcbItemsName, idx, 1);
        this._fireLogFire('lcb-deleted', deletedItem);
      }
    },

    /**
     * Delete the item that sent the 'lcb-delete-me' event.
     *
     * @param evt {object}
     * @private
     */
    _lcbDeleteMe: function (evt) {
      if (evt && evt.model && _.isNumber(evt.model.index)) {
        this.lcbDelete(evt.model.index);
      }
    },

    /**
     * Set to true, or toggle, the boolean 'lcbTrashed' property of the item that sent the 'lcb-trash-me' event.
     *
     * @param evt {object}
     * @private
     */
    _lcbTrashMe: function (evt) {
      if (evt && evt.model && evt.model.item) {
        var trashed = _.isBoolean(evt.model.item.lcbTrashed) ? !evt.model.item.lcbTrashed : true;
        evt.model.set('item.lcbTrashed', trashed);
        this._fireLogFire('lcb-trashed', evt.model.item);
      }
    },
    /**
     * Delete all trashed items.
     */
    lcbEmptyTrash: function () {
      var _this = this;
      _.forEachRight(this[this.lcbItemsName], function (item, idx) {
        if (item.lcbTrashed) {
          _this.lcbDelete(idx);
        }
      });
    },

    _isValidIndex: function (idx) {
      return _.isNumber(idx) && _.inRange(idx, this[this.lcbItemsName].length);
    },

    lcbLogItems: function () {
      this._fireLog(this.lcbItemsName + ':', this[this.lcbItemsName]);
    }

  };
  LeisureLinkBehaviors.CollectionBehavior = [LeisureLinkBehaviors.FireLogBehavior, LeisureLinkBehaviors.CollectionBehaviorImpl]
</script>